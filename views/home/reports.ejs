<!-- 
  
  Home.Delivery.Reports

  * This file is the page where the reports from a delivery are manage

 -->

<div class="hidden">
  <input type="hidden" value="<%= delivery.id %>" id="DELIVERY_ID"/>
</div>


<div class="container" id="deliveryStats">

  <div class="row">
    <h1>
      <a href="/"><%= __('Home') %></a> / 
      <a href="/delivery"><%= __('Deliveries') %></a> / 
      <a href="/delivery/reports/<%= delivery.id %>"><%= __('Reports') %></a>
    </h1>
  </div>

  <div class="row">



    <div class="col-sm-6">
      <table class="table table-hover table-striped">
        <tbody>
          <tr>
            <td><%= __('Delivery.Stats.id') %></td><td><%= delivery.id %></td>
          </tr>
          <tr>
            <td><%= __('Delivery.Stats.createdAt') %></td><td><%= Utils.formatDate(delivery.createdAt) %></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="col-sm-6">

      <div id="menu" class="square">
        <ul>
          <li>
            <a href="/delivery/station/<%= delivery.id %>">
              <i class="fa fa-bus"></i>
              <h4><%= __('Station') %></h4>
            </a>
          </li>
          <li>
            <a href="/delivery">
              <i class="fa fa-list"></i>
              <h4><%= __('Deliveries') %></h4>
            </a>
          </li>
          <li>
            <a href="/">
              <i class="fa fa-home"></i>
              <h4><%= __('Home') %></h4>
            </a>
          </li>
        </ul>
      </div>


    </div>

  </div>


  <div class="row">
    <div class="col-sm-12">
      <table class="table table-hover table-striped">
        <thead>
          <tr>
            <th><%= __('Report.Name') %></th>
            <th><%= __('Report.Status') %></th>
            <th>&nbsp;</th>
          </tr>
        </thead>
        <tbody>
          <tr id="transferReportRow">
            <td><%= __('Report.Transfer') %></td>
            <td id="transferReportStatus"></td>
            <td>
              <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                  <%= __('Actions') %> <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu">
                  <li>
                    <a class="complete-link" data-report="transfer" id="tranferCompleteLink" href="/delivery/reports/transfer/<%= delivery.id %>"><%= __('Complete') %></a>
                  </li>
                  <li>
                    <a class="print-link" data-report="transfer" href="/delivery/reports/print/transfer?delivery=<%= delivery.id %>"><%= __('Print') %></a>
                  </li>
                </ul>
              </div>
            </td>
          </tr>
          <tr id="inspectionReportRow">
            <td><%= __('Report.Inspection') %></td>
            <td id="inspectionReportStatus"></td>
            <td>
              <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                  <%= __('Actions') %> <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu">
                  <li>
                    <a class="complete-link" data-report="inspection" id="inspectionCompleteLink"  href="/delivery/reports/inspection/<%= delivery.id %>"><%= __('Complete') %></a>
                  </li>
                  <li>
                    <a class="print-link" data-report="inspection"  href="/delivery/reports/print/inspection?delivery=<%= delivery.id %>"><%= __('Print') %></a>
                  </li>
                </ul>
              </div>
            </td>
          </tr>
          <tr id="sealReportRow">
            <td><%= __('Report.Seal') %></td>
            <td id="sealReportStatus"></td>
            <td>
              <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                  <%= __('Actions') %> <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu">
                  <li>
                    <a  id="sealCompleteLink" data-report="seal"  href="/delivery/reports/seal/<%= delivery.id %>"><%= __('Complete') %></a>
                  </li>
                  <li>
                    <a class="print-link" data-report="seal"  href="/delivery/reports/print/seal?delivery=<%= delivery.id %>"><%= __('Print') %></a>
                  </li>
                </ul>
              </div>
            </td>
          </tr>
        </tbody>
      </table>


    </div>

  </div>


</div>

<%- partial('./partials/modal.report.seal.ejs') %>


<script type="text/javascript">
window.addEventListener('load', function () {

  var delivery = document.getElementById('DELIVERY_ID').value;


  // Transfer Report
  socket.get('/_api/report/transferiscomplete', { delivery: delivery }, function (response) {
    if (response.error) return console.log(response.error);
    if (response.isComplete) {
      $('#transferReportRow').addClass('success');
      $('#transferReportStatus').html('complete');
    } else {
      $('#transferReportRow').addClass('warning');
      $('#transferReportStatus').html('incomplete');
    }
  });



  // Inspection Report
  socket.get('/_api/report/inspectioniscomplete', { delivery: delivery }, function (response) {
    if (response.error) return console.log(response.error);
    if (response.isComplete) {
      $('#inspectionReportRow').addClass('success');
      $('#inspectionReportStatus').html('complete');
    } else {
      $('#inspectionReportRow').addClass('warning');
      $('#inspectionReportStatus').html('incomplete');
    }
  });



  // Seal Report
  socket.get('/_api/report/sealiscomplete', { delivery: delivery }, function (response) {
    if (response.error) return console.log(response.error);
    if (response.isComplete) {
      $('#sealReportRow').addClass('success');
      $('#sealReportStatus').html('complete');
    } else {
      $('#sealReportRow').addClass('warning');
      $('#sealReportStatus').html('incomplete');
    }
  });



  // Complete links
  $('.complete-link').on('click', function (e) {
    e.preventDefault();
    var report = $(this).attr('data-report');
    var href = $(this).attr('href');
    socket.get('/_api/report/' + report + 'iscomplete', { delivery: delivery }, function (response) {
      if (response.error) return console.log(response.error);
      if (response.isComplete) {
        var confirm = new WindowConfirm();
        confirm.setMessage('This report is already complete, are you sure you want to compile it again?');
        confirm.setConfirm(function () {
          return window.location.href = href;
        });
        confirm.show();
      }
      else {
        return window.location.href = href;        
      }
    });
  });


  // Print links
  $('.print-link').on('click', function (e) {
    e.preventDefault();
    var report = $(this).attr('data-report');
    var href = $(this).attr('href');
    socket.get('/_api/report/' + report + 'iscomplete', { delivery: delivery }, function (response) {
      if (response.error) return console.log(response.error);
      if (!response.isComplete) {
        var alert = new WindowAlert();
        alert.setMessage('You need to complete the report before you can print it!');
        alert.show();
      }
      else {
        socket.get(href, function (response) {
          if (response.error) return console.log(response.error);
          if (response.url) {
            return Utils.popupWindow(response.url, 1200, 800);
          }
        })
      }
    });   
  });





  $('#sealCompleteLink').on('click', function (e) {
    e.preventDefault();
    var report = $(this).attr('data-report');
    var href = $(this).attr('href');
    socket.get('/_api/report/' + report + 'iscomplete', { delivery: delivery }, function (response) {
      if (response.error) return console.log(response.error);
      if (response.isComplete) {
        var confirm = new WindowConfirm();
        confirm.setMessage('This report is already complete, are you sure you want to compile it again?');
        confirm.setConfirm(function () {
          show_seal_form(delivery, href);
        });
        confirm.show();
      }
      else {
        show_seal_form(delivery, href);
      }
    });

  });


  $('#ModalSealReport').on('hide.bs.modal', function () {
    $(this).find('#SealReportForm').parsley().reset();
  })



});




function show_seal_form (delivery, href) {
  $modal = $('#ModalSealReport');
  $modal.find('#SealReportForm').attr('action', href);
  $modal.find('#SealReportDelivery').attr('value', delivery);
  $modal.modal('show'); 
  window.setTimeout(function () {
    $modal.find('#firstSeal').focus()
  }, 700); 
}
</script>










































